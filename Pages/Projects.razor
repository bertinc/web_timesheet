@page "/projects"
@using System.Net.Http.Json
@using System.Threading.Tasks
@using System.Text.Json
@using System.Text;
@inject HttpClient Http
@inject IJSRuntime JsRuntime
@using TimeSheet.Models

<PageTitle>Projects</PageTitle>

<div class="app">
    <header class="header">Manage Projects</header>

    <div class="main">
        <aside class="toolbar">
            <nav>
                <ul>
                    <li><a href=".">Back to Home</a></li>
                    <li>
                        <label for="code">Project Code:</label>
                        <input id="code" type="text" @bind="newProject.Code" placeholder="e.g., PROJ001" />
                    </li>
                    <li>
                        <label for="name">Project Name:</label>
                        <input id="name" type="text" @bind="newProject.Name" placeholder="e.g., Website Redesign" />
                    </li>
                    <li>
                        <label for="duedate">Due Date:</label>
                        <input id="duedate" type="date" @bind="dueDate" />
                    </li>
                    <li>
                        <label style="float:left" for="blankdate">No Due Date:</label>
                        <input id="blankdate" type="checkbox" @bind="blankDate" />
                    </li>
                    <li>
                        <label for="company">Company:</label>
                        <select id="company" @bind="newProject.CompanyId">
                            <option value="">Select a Company</option>
                            @foreach (var comp in companies.Companies ?? new List<Company>())
                            {
                                <option value="@comp.Id">@comp.Name</option>
                            }
                        </select>
                    </li>
                    <li>
                        <label for="description">Description:</label>
                        <textarea id="description" rows="4" @bind="newProject.Description" class="w-100" placeholder="Project description"></textarea>
                    </li>
                    <li><button @onclick="AddProject">Add Project</button></li>
                </ul>
            </nav>
        </aside>

        <section class="content">
            <h3>Existing Projects</h3>
            @if (projects.Projects != null && projects.Projects.Count > 0)
            {
                <table class="results_table" id="projects">
                    <thead>
                        <tr>
                            <th>ID</th>
                            <th>Code</th>
                            <th>Name</th>
                            <th>Due Date</th>
                            <th>Company</th>
                            <th>Description</th>
                            <th>Actions</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var project in projects.Projects)
                        {
                            <tr @onclick="@(() => OpenEditModal(project))" style="cursor: pointer;">
                                <td>@project.Id</td>
                                <td>@project.Code</td>
                                <td>@project.Name</td>
                                <td>@(string.IsNullOrEmpty(project.DueDate) ? "-" : project.DueDate)</td>
                                <td>@(string.IsNullOrEmpty(project.CompanyName) ? "-" : project.CompanyName)</td>
                                <td class="small">@(string.IsNullOrEmpty(project.Description) ? "-" : project.Description)</td>
                                <td>
                                    <button @onclick="@(() => RemoveProject(@project.Id))" @onclick:stopPropagation="true">Remove</button>
                                </td>
                            </tr>
                        }
                        <tr>
                            <td colspan="100">Found @projects.Count projects</td>
                        </tr>
                    </tbody>
                </table>
            }
            else
            {
                <p>No projects found.</p>
            }
        </section>
    </div>

    <footer class="footer">
        <label hidden="@hide_it">@label_text</label>
    </footer>
</div>

@if (showEditModal)
{
    <div class="modal-backdrop" @onclick="CloseEditModal">
        <div class="modal-content" @onclick:stopPropagation="true">
            <h3>Edit Project #@editingProject.Id</h3>
            <div class="modal-body">
                <div class="form-group">
                    <label for="edit-code">Project Code:</label>
                    <input id="edit-code" type="text" @bind="editingProject.Code" />
                </div>
                <div class="form-group">
                    <label for="edit-name">Project Name:</label>
                    <input id="edit-name" type="text" @bind="editingProject.Name" />
                </div>
                <div class="form-group">
                    <label for="edit-duedate">Due Date:</label>
                    <input id="edit-duedate" type="date" @bind="editingProject.DueDate" />
                </div>
                <div class="form-group">
                    <label for="edit-blankdate">No Due Date:</label>
                    <input id="edit-blankdate" type="checkbox" @bind="editingProject.NoDueDate" />
                </div>
                <div class="form-group">
                    <label for="edit-company">Company:</label>
                    <select id="edit-company" @bind="editingProject.CompanyId">
                        <option value="">None</option>
                        @foreach (var comp in companies.Companies ?? new List<Company>())
                        {
                            <option value="@comp.Id">@comp.Name</option>
                        }
                    </select>
                </div>
                <div class="form-group">
                    <label for="edit-description">Description:</label>
                    <textarea id="edit-description" rows="4" @bind="editingProject.Description"></textarea>
                </div>
            </div>
            <div class="modal-footer">
                <button @onclick="SaveEditedProject">Save</button>
                <button @onclick="CloseEditModal">Cancel</button>
            </div>
        </div>
    </div>
}

@if (showDeleteModal)
{
    <div class="modal-backdrop" @onclick="@CancelDeleteProject">
        <div class="modal-content" @onclick:stopPropagation="true">
            <h3>Confirm Delete</h3>
            <div class="modal-body">
                <p>Are you sure you want to delete the project "<strong>@deleteItemName</strong>"?</p>
                <p>This action cannot be undone.</p>
            </div>
            <div class="modal-footer">
                <button @onclick="@ConfirmDeleteProject" style="background-color: #e74c3c;">Delete</button>
                <button @onclick="@CancelDeleteProject">Cancel</button>
            </div>
        </div>
    </div>
}

@code {
    private bool hide_it = true;
    private string label_text = "Some Text";
    private string api_base = "http://10.0.0.192:8001/";
    private string proj_endpoint = "projects";
    private ProjectsResponse projects = new ProjectsResponse();
    private CompaniesResponse companies = new CompaniesResponse();
    private DateTime dueDate = DateTime.Today;
    private Project newProject = new Project();
    private bool blankDate = true;
    
    private bool showEditModal = false;
    private EditProjectModel editingProject = new EditProjectModel();
    
    private bool showDeleteModal = false;
    private string deleteItemName = string.Empty;
    private int deleteItemId = 0;

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            await GetCompanies();
            await GetProjects();
            StateHasChanged();
        }
    }

    public async Task GetCompanies()
    {
        var resp = await Http.GetAsync(api_base + "companies");
        if (resp.IsSuccessStatusCode)
        {
            companies = await resp.Content.ReadFromJsonAsync<CompaniesResponse>();
        }
    }

    public async Task GetProjects()
    {
        var resp = await Http.GetAsync(api_base + proj_endpoint);
        if (resp.IsSuccessStatusCode)
        {
            projects = await resp.Content.ReadFromJsonAsync<ProjectsResponse>();
            label_text = $"Loaded {projects.Projects?.Count ?? 0} projects.";
        }
        else
        {
            label_text = $"Error loading projects: {resp.StatusCode}";
        }
        hide_it = false;
    }

    private async Task AddProject()
    {
        if (string.IsNullOrWhiteSpace(newProject.Code) || string.IsNullOrWhiteSpace(newProject.Name))
        {
            label_text = "Code and Name are required fields.";
            hide_it = false;
            return;
        }

        if (newProject.CompanyId.HasValue && newProject.CompanyId > 0)
        {
            var selectedCompany = companies.Companies?.FirstOrDefault(c => c.Id == newProject.CompanyId);
            if (selectedCompany != null)
            {
                newProject.CompanyName = selectedCompany.Name;
            }
        }

        newProject.DueDate = dueDate.ToString("yyyy-MM-dd");

        var payload = new
        {
            code = newProject.Code,
            name = newProject.Name,
            due_date = blankDate ? null : newProject.DueDate,
            company_id = newProject.CompanyId,
            description = newProject.Description
        };

        var json = JsonSerializer.Serialize(payload);
        var content = new StringContent(json, System.Text.Encoding.UTF8, "application/json");

        try
        {
            var resp = await Http.PostAsync(api_base + proj_endpoint, content);
            var respContent = await resp.Content.ReadAsStringAsync();
            if (resp.IsSuccessStatusCode)
            {
                label_text = $"Project '{newProject.Name}' added successfully.";
                newProject = new Project();
            }
            else
            {
                label_text = $"Error: {resp.StatusCode} - {respContent}";
            }
        }
        catch (Exception ex)
        {
            label_text = $"Error adding project: {ex.Message}";
        }

        await GetProjects();
        hide_it = false;
    }

    private async Task UpdateProject(int projectId, string code, string name, string dueDate, int? companyId, string description)
    {
        if (string.IsNullOrWhiteSpace(code) || string.IsNullOrWhiteSpace(name))
        {
            label_text = "Code and Name are required fields.";
            hide_it = false;
            return;
        }

        var payload = new
        {
            project_id = projectId,
            code = code,
            name = name,
            due_date = dueDate,
            company_id = companyId,
            description = description
        };

        var json = JsonSerializer.Serialize(payload);

        using var req = new HttpRequestMessage(HttpMethod.Put, api_base + proj_endpoint)
        {
            Content = new StringContent(json, Encoding.UTF8, "application/json")
        };

        try
        {
            var resp = await Http.SendAsync(req);
            var respContent = await resp.Content.ReadAsStringAsync();
            if (resp.IsSuccessStatusCode)
            {
                label_text = $"Project '{name}' updated successfully.";
            }
            else
            {
                label_text = $"Error: {resp.StatusCode} - {respContent}";
            }
        }
        catch (Exception ex)
        {
            label_text = $"Error updating project: {ex.Message}";
        }

        await GetProjects();
        hide_it = false;
    }

    private async Task RemoveProject(int projectId)
    {
        var project = projects.Projects?.FirstOrDefault(p => p.Id == projectId);
        if (project == null)
        {
            label_text = "Project not found.";
            hide_it = false;
            return;
        }

        deleteItemId = projectId;
        deleteItemName = project.Name;
        showDeleteModal = true;
    }

    private async Task ConfirmDeleteProject()
    {
        showDeleteModal = false;

        var payload = new { project_id = deleteItemId };
        var json = JsonSerializer.Serialize(payload);
        var content = new StringContent(json, Encoding.UTF8, "application/json");

        using var req = new HttpRequestMessage(HttpMethod.Delete, proj_endpoint)
        {
            Content = new StringContent(json, Encoding.UTF8, "application/json")
        };

        try
        {
            var resp = await Http.SendAsync(req);
            var respContent = await resp.Content.ReadAsStringAsync();
            if (resp.IsSuccessStatusCode)
            {
                label_text = $"Project '{deleteItemName}' removed successfully.";
            }
            else
            {
                label_text = $"Error: {resp.StatusCode} - {respContent}";
            }
        }
        catch (Exception ex)
        {
            label_text = $"Error removing project: {ex.Message}";
        }

        await GetProjects();
        hide_it = false;
    }

    private void CancelDeleteProject()
    {
        showDeleteModal = false;
    }

    private async Task EditProject(Project project)
    {
        editingProject = new EditProjectModel
        {
            Id = project.Id,
            Code = project.Code,
            Name = project.Name,
            DueDate = DateTime.Parse(project.DueDate),
            CompanyId = project.CompanyId,
            Description = project.Description
        };
        showEditModal = true;
    }

    private async Task SaveEdit()
    {
        if (editingProject.Id <= 0)
        {
            label_text = "Invalid project ID.";
            hide_it = false;
            return;
        }

        var payload = new
        {
            project_id = editingProject.Id,
            code = editingProject.Code,
            name = editingProject.Name,
            due_date = editingProject.DueDate.ToString("yyyy-MM-dd"),
            company_id = editingProject.CompanyId,
            description = editingProject.Description
        };

        var json = JsonSerializer.Serialize(payload);

        using var req = new HttpRequestMessage(HttpMethod.Put, api_base + proj_endpoint)
        {
            Content = new StringContent(json, Encoding.UTF8, "application/json")
        };

        try
        {
            var resp = await Http.SendAsync(req);
            var respContent = await resp.Content.ReadAsStringAsync();
            if (resp.IsSuccessStatusCode)
            {
                label_text = $"Project '{editingProject.Name}' updated successfully.";
            }
            else
            {
                label_text = $"Error: {resp.StatusCode} - {respContent}";
            }
        }
        catch (Exception ex)
        {
            label_text = $"Error updating project: {ex.Message}";
        }

        showEditModal = false;
        await GetProjects();
        hide_it = false;
    }

    private void OpenEditModal(Project project)
    {
        editingProject = new EditProjectModel
        {
            Id = project.Id,
            Code = project.Code ?? string.Empty,
            Name = project.Name ?? string.Empty,
            DueDate = string.IsNullOrEmpty(project.DueDate) ? DateTime.Today : DateTime.Parse(project.DueDate),
            NoDueDate = string.IsNullOrEmpty(project.DueDate),
            CompanyId = project.CompanyId,
            Description = project.Description ?? string.Empty
        };
        showEditModal = true;
    }

    private void CloseEditModal()
    {
        showEditModal = false;
    }

    private async Task SaveEditedProject()
    {
        string dueDateStr = editingProject.NoDueDate ? null : editingProject.DueDate.ToString("yyyy-MM-dd");
        
        await UpdateProject(
            editingProject.Id,
            editingProject.Code,
            editingProject.Name,
            dueDateStr,
            editingProject.CompanyId,
            editingProject.Description
        );
        CloseEditModal();
    }

    public class EditProjectModel
    {
        public int Id { get; set; }
        public string Code { get; set; } = string.Empty;
        public string Name { get; set; } = string.Empty;
        public DateTime DueDate { get; set; }
        public bool NoDueDate { get; set; }
        public int? CompanyId { get; set; }
        public string Description { get; set; } = string.Empty;
    }
}
